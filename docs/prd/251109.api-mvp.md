# PRD: Chatbot Integration API MVP

**Date:** 2025-11-09
**Last Updated:** 2025-11-09
**Platform:** Telegram Bot API
**Architecture Pattern:** Server Actions with API Adapter Layer

## 1. Vision

To provide a secure and efficient API that enables users to manage their tasks through Telegram, offering a seamless and convenient way to interact with the application without context switching from their preferred messaging platform.

## 2. Target Audience

*   **Existing Users:** Users who are already using the web application and want a faster way to manage their tasks on-the-go.
*   **New Users:** Users who prefer a conversational interface for task management.
*   **Mobile-First Users:** Users who primarily interact via mobile messaging apps.

## 3. User Stories & Features

### 3.1. Authentication
*   As a user, I want to securely authenticate my Telegram account with my web application account.
*   As a user, I want to receive a simple verification token that I can paste into Telegram.
*   As a user, I want my session to remain active for 30 days without re-authentication.
*   As a user, I want to be able to revoke chatbot access from the web application.

### 3.2. Task Management
*   As a user, I want to create a new task by sending a message to the Telegram bot.
*   As a user, I want to view my tasks in a readable format within Telegram.
*   As a user, I want to mark tasks as complete directly from Telegram.
*   As a user, I want to update task details (title, description) via the bot.
*   As a user, I want to delete tasks through the bot interface.

## 4. API Design

### 4.1. Authentication Flow

**Overview:** OAuth-like flow where users authenticate via web and receive a token to paste into Telegram.

**Step 1: User Initiates Login from Telegram**

1.  User sends `/login` command to the Telegram bot.
2.  Bot responds with: "Click here to authorize: https://yourapp.com/chatbot-login"

**Step 2: User Logs In and Generates a Verification Code**

1.  User clicks the link and is directed to the `chatbot-login` page.
2.  User logs in using their standard Firebase Authentication method (Google, Email/Password).
3.  After successful login, a server action (`generateChatbotVerificationCode()`) executes:
    a.  Generates a secure, random 9-character verification code (e.g., `ABC123XYZ`)
    b.  Stores a SHA-256 hash of the code in Firestore: `users/{userId}/chatbotVerificationCodes/{codeId}`
    c.  Sets expiration time: 5 minutes from creation
    d.  Returns the plain-text code to display
4.  The page displays: "Enter this command in Telegram: `/authorize ABC123XYZ`"

**Step 3: User Enters the Verification Code in Telegram**

1.  User copies and pastes `/authorize ABC123XYZ` into Telegram.
2.  The Telegram bot receives the command and extracts the code.

**Step 4: Bot Validates Code and Receives Session Token**

1.  Bot calls `POST /api/chatbot/auth/verify` with:
    ```json
    {
      "verificationCode": "ABC123XYZ",
      "telegramUserId": "123456789"
    }
    ```
2.  The API endpoint:
    a.  Hashes the provided code
    b.  Searches Firestore for matching hash
    c.  Verifies code is not expired (< 5 minutes old)
    d.  If valid, generates a 30-day session token (JWT)
    e.  Stores session in `users/{userId}/chatbotSessions/{sessionId}`
    f.  Deletes the verification code
    g.  Returns the session token
3.  Response:
    ```json
    {
      "sessionToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "expiresAt": "2025-12-09T00:00:00Z",
      "userId": "user123"
    }
    ```

**Step 5: Bot Uses Session Token for All Requests**

1.  Bot stores the `sessionToken` in its database, linked to the Telegram user ID.
2.  For all future API requests, bot includes: `Authorization: Bearer {sessionToken}`

**Step 6: Token Revocation (Optional)**

1.  User can revoke access from web app settings page.
2.  Calls `DELETE /api/chatbot/auth/revoke` with session ID.
3.  Session deleted from Firestore, token becomes invalid.

### 4.2. Token Specifications

#### Verification Code
- **Format:** 9-character alphanumeric (uppercase)
- **Character Set:** A-Z, 2-9 (excludes 0, O, 1, I, L to avoid confusion)
- **Example:** `ABC234XYZ`
- **Expiration:** 5 minutes
- **Single-use:** Deleted after successful validation
- **Storage:** SHA-256 hash stored in Firestore

#### Session Token (JWT)
- **Algorithm:** HS256 (symmetric signing)
- **Expiration:** 30 days from creation
- **Payload:**
  ```json
  {
    "userId": "user123",
    "type": "chatbot",
    "platform": "telegram",
    "telegramUserId": "123456789",
    "createdAt": 1699564800,
    "expiresAt": 1702243200,
    "sessionId": "session_abc123"
  }
  ```
- **Storage:** Session metadata stored in `users/{userId}/chatbotSessions/{sessionId}`
  ```json
  {
    "sessionId": "session_abc123",
    "userId": "user123",
    "telegramUserId": "123456789",
    "createdAt": "2025-11-09T00:00:00Z",
    "expiresAt": "2025-12-09T00:00:00Z",
    "lastUsedAt": "2025-11-09T12:30:00Z",
    "isActive": true
  }
  ```
- **Revocation:** Delete session document from Firestore; token becomes invalid immediately

### 4.3. Task Management API Endpoints

**Base URL:** `/api/chatbot`

All endpoints require the `Authorization: Bearer <sessionToken>` header.

**Architecture Note:** These endpoints are thin adapters that wrap existing server actions from `src/features/tasks/application/actions.ts`. They:
1. Validate the JWT and extract `userId`
2. Call the existing server action with the `userId`
3. Transform the response to JSON format

#### `GET /api/chatbot/tasks`

**Description:** Get a list of all tasks for the authenticated user.

**Headers:**
```
Authorization: Bearer <sessionToken>
```

**Response:** `200 OK`
```json
{
  "tasks": [
    {
      "id": "task1",
      "title": "My First Task",
      "description": "Task details here",
      "isCompleted": false,
      "importance": "high",
      "dueDate": "2025-11-15T00:00:00Z",
      "timeEstimate": 60,
      "source": "web",
      "createdAt": "2025-11-09T10:00:00Z",
      "updatedAt": "2025-11-09T10:00:00Z"
    }
  ],
  "total": 1
}
```

**Error Response:** `401 Unauthorized`
```json
{
  "error": {
    "code": "UNAUTHORIZED",
    "message": "Invalid or expired session token"
  }
}
```

#### `POST /api/chatbot/tasks`

**Description:** Create a new task.

**Headers:**
```
Authorization: Bearer <sessionToken>
```

**Request Body:**
```json
{
  "title": "New Task from Telegram",
  "description": "Optional task description",
  "importance": "medium",
  "dueDate": "2025-11-20T00:00:00Z",
  "timeEstimate": 30
}
```

**Field Validation:**
- `title`: Required, 1-200 characters, string
- `description`: Optional, max 1000 characters, string
- `importance`: Optional, enum: `"high" | "medium" | "low"`, defaults to `"medium"`
- `dueDate`: Optional, ISO 8601 datetime string
- `timeEstimate`: Optional, integer (minutes), range: 1-480
- `source`: Auto-set to `"chatbot"`, read-only

**Response:** `201 Created`
```json
{
  "task": {
    "id": "task2",
    "title": "New Task from Telegram",
    "description": "Optional task description",
    "isCompleted": false,
    "importance": "medium",
    "dueDate": "2025-11-20T00:00:00Z",
    "timeEstimate": 30,
    "source": "chatbot",
    "createdAt": "2025-11-09T12:00:00Z",
    "updatedAt": "2025-11-09T12:00:00Z"
  }
}
```

**Error Response:** `400 Bad Request`
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Title is required",
    "field": "title"
  }
}
```

#### `PATCH /api/chatbot/tasks/:id`

**Description:** Update an existing task. Only provided fields will be updated.

**Headers:**
```
Authorization: Bearer <sessionToken>
```

**Request Body:** (all fields optional)
```json
{
  "title": "Updated Task Title",
  "description": "Updated description",
  "isCompleted": true,
  "importance": "low"
}
```

**Response:** `200 OK`
```json
{
  "task": {
    "id": "task1",
    "title": "Updated Task Title",
    "description": "Updated description",
    "isCompleted": true,
    "importance": "low",
    "dueDate": "2025-11-15T00:00:00Z",
    "timeEstimate": 60,
    "source": "web",
    "createdAt": "2025-11-09T10:00:00Z",
    "updatedAt": "2025-11-09T13:00:00Z"
  }
}
```

**Error Response:** `404 Not Found`
```json
{
  "error": {
    "code": "NOT_FOUND",
    "message": "Task not found or you don't have permission to access it"
  }
}
```

#### `DELETE /api/chatbot/tasks/:id`

**Description:** Delete a task.

**Headers:**
```
Authorization: Bearer <sessionToken>
```

**Response:** `204 No Content`

**Error Response:** `404 Not Found`
```json
{
  "error": {
    "code": "NOT_FOUND",
    "message": "Task not found or you don't have permission to delete it"
  }
}
```

### 4.4. Error Response Format

All error responses follow this structure:

```json
{
  "error": {
    "code": "ERROR_CODE",
    "message": "Human-readable error message",
    "field": "fieldName"  // Optional, for validation errors
  }
}
```

**Standard Error Codes:**
- `UNAUTHORIZED` (401) - Invalid or expired token
- `FORBIDDEN` (403) - Valid token but insufficient permissions
- `NOT_FOUND` (404) - Resource not found
- `VALIDATION_ERROR` (400) - Invalid request data
- `RATE_LIMIT_EXCEEDED` (429) - Too many requests
- `INTERNAL_ERROR` (500) - Server error

## 5. Security Considerations

### 5.1. Authentication Security

**JWT Signing:**
- Algorithm: HS256 (HMAC with SHA-256)
- Secret key stored in environment variable: `JWT_SECRET`
- Secret must be at least 256 bits (32 bytes) of cryptographically random data
- Rotate secret periodically (invalidates all existing tokens)

**Verification Code Security:**
- Generate using cryptographically secure random number generator (`crypto.randomBytes()`)
- Store SHA-256 hash only (never plain text)
- 5-minute expiration window
- Single-use: delete after validation
- Rate limit code generation: max 5 codes per user per hour

**Session Token Security:**
- 30-day expiration
- Include session ID in payload for revocation support
- Validate on every request:
  1. Verify JWT signature
  2. Check expiration timestamp
  3. Verify session exists in Firestore and `isActive: true`
- Update `lastUsedAt` timestamp on each request

### 5.2. Transport Security

**HTTPS Only:**
- All API endpoints must use HTTPS in production
- Reject HTTP requests (redirect to HTTPS)
- Use HSTS headers: `Strict-Transport-Security: max-age=31536000; includeSubDomains`

**CORS:**
- Not required for Telegram Bot API (server-to-server communication)
- If future web-based chatbot is added, configure specific allowed origins only

### 5.3. Authorization

**Ownership Verification:**
- Every task operation verifies: `task.userId === authenticatedUserId`
- Return 404 (not 403) for unauthorized access to prevent information disclosure
- Never expose other users' task data

**Principle of Least Privilege:**
- Chatbot tokens can only access task CRUD operations
- Cannot access: user profile updates, payment info, admin functions

### 5.4. Rate Limiting

**Per-User Limits:**
- 100 requests per hour per user
- Calculated using sliding window algorithm
- Storage: Firestore counter or Redis
- Response when exceeded:
  ```
  HTTP/1.1 429 Too Many Requests
  Retry-After: 3600
  Content-Type: application/json

  {
    "error": {
      "code": "RATE_LIMIT_EXCEEDED",
      "message": "Too many requests. Please try again later.",
      "retryAfter": 3600
    }
  }
  ```

**Endpoint-Specific Limits:**
- Auth endpoints: 10 requests/hour (prevents brute force)
- Read operations: 100 requests/hour
- Write operations: 50 requests/hour

### 5.5. Input Validation & Sanitization

**All Inputs:**
- Validate against schema using Zod
- Reject requests with unknown fields
- Sanitize strings to prevent XSS (though stored in Firestore, not rendered as HTML)
- Enforce max length limits on all string fields

**Specific Validations:**
- `title`: Required, 1-200 chars, strip whitespace
- `description`: Optional, max 1000 chars
- `importance`: Enum validation (high/medium/low only)
- `dueDate`: Valid ISO 8601 datetime, not in the past
- `timeEstimate`: Integer, range 1-480 minutes

### 5.6. Logging & Monitoring

**Security Logging:**
- Log all authentication attempts (success and failure)
- Log all token generation and revocation events
- Log rate limit violations
- Log authorization failures (404 responses)

**Privacy Considerations:**
- Never log full tokens (log last 4 characters only)
- Never log user passwords or verification codes
- Log user IDs and Telegram user IDs for audit trail

## 6. Architecture Integration

### 6.1. Feature Structure

New feature: `chatbot-integration`

```
src/features/chatbot-integration/
├── domain/
│   ├── entities/
│   │   ├── chatbot-session.ts          # Session entity
│   │   └── verification-code.ts        # Verification code entity
│   ├── repositories/
│   │   ├── chatbot-session-repository.ts  # Session repository interface
│   │   └── verification-code-repository.ts
│   └── value-objects/
│       └── session-token.ts            # JWT token value object
├── application/
│   ├── services/
│   │   ├── chatbot-auth-service.ts     # Token generation/validation
│   │   └── chatbot-task-service.ts     # Task operations (wraps existing)
│   ├── dtos/
│   │   ├── create-task-request.dto.ts
│   │   ├── update-task-request.dto.ts
│   │   └── task-response.dto.ts
│   └── ports/
│       └── jwt-service.port.ts         # JWT abstraction
├── infrastructure/
│   ├── persistence/
│   │   ├── firestore-chatbot-session-repository.ts
│   │   └── firestore-verification-code-repository.ts
│   └── jwt/
│       └── jsonwebtoken-service.ts     # JWT implementation (using 'jsonwebtoken' package)
└── presentation/
    ├── api/
    │   └── chatbot/
    │       ├── auth/
    │       │   └── verify/
    │       │       └── route.ts        # POST /api/chatbot/auth/verify
    │       └── tasks/
    │           ├── route.ts            # GET/POST /api/chatbot/tasks
    │           └── [id]/
    │               └── route.ts        # PATCH/DELETE /api/chatbot/tasks/:id
    └── pages/
        └── chatbot-login-page.tsx      # Renders chatbot login UI
```

### 6.2. Reuse of Existing Code

**Task Operations:**
- Reuse `src/features/tasks/application/actions.ts`
- Reuse `src/features/tasks/domain/repositories/task-repository.ts`
- Reuse `src/features/tasks/infrastructure/persistence/firestore-task-repository.ts`

**Authentication:**
- Reuse `src/features/auth/infrastructure/auth/firebase-auth-repository.ts` for user verification
- Extend auth service with chatbot-specific methods

**Database:**
- Reuse `src/shared/infrastructure/database/database-service.ts` for Firestore access

### 6.3. New Dependencies

**NPM Packages:**
- `jsonwebtoken` (^9.0.2) - JWT generation and verification
- `@types/jsonwebtoken` (^9.0.5) - TypeScript types

**Environment Variables:**
```env
JWT_SECRET=<256-bit-secret-key>  # Generate with: openssl rand -base64 32
CHATBOT_LOGIN_URL=https://yourapp.com/chatbot-login
```

## 7. Success Criteria & MVP Scope

### 7.1. Success Criteria

MVP is successful if:
- [ ] Users can authenticate from Telegram within 60 seconds
- [ ] Users can create/read/update/delete tasks via Telegram bot
- [ ] API response time < 500ms for 95th percentile
- [ ] Zero security incidents in first month of production
- [ ] 10+ active users successfully complete authentication flow
- [ ] Error rate < 1% across all API endpoints

### 7.2. In Scope for MVP

**Authentication:**
- Web-based login flow with verification code
- 30-day session tokens
- Token revocation from web app

**Task Management:**
- Create task with title, description, importance, due date, time estimate
- List all tasks
- Update task fields
- Mark task as complete
- Delete task

**Security:**
- JWT authentication
- Rate limiting (100 req/hour)
- Input validation
- HTTPS enforcement

### 7.3. Out of Scope for MVP

**Features:**
- AI task prioritization via chatbot
- Time blocking features
- Task search and filtering
- Pagination (will return all tasks)
- Bulk operations (create/update/delete multiple tasks)
- Task attachments or file uploads
- Task categories or tags
- Recurring tasks
- Task collaboration/sharing

**Integrations:**
- Google Tasks integration
- Calendar integration
- Other messaging platforms (WhatsApp, Slack, etc.)

**Advanced Features:**
- Token refresh mechanism (user re-authenticates after 30 days)
- Multi-device session management
- Push notifications to Telegram
- Task reminders

## 8. Implementation Plan

### 8.1. Phase 1: Authentication (Week 1)

**Tasks:**
1. Create chatbot-integration feature structure
2. Implement verification code generation service
3. Implement JWT service with signing and validation
4. Create Firestore repositories for verification codes and sessions
5. Build `chatbot-login` page UI
6. Implement `POST /api/chatbot/auth/verify` endpoint
7. Implement `DELETE /api/chatbot/auth/revoke` endpoint
8. Write unit tests for auth services

### 8.2. Phase 2: Task API (Week 2)

**Tasks:**
1. Create API adapters for task operations
2. Implement `GET /api/chatbot/tasks` endpoint
3. Implement `POST /api/chatbot/tasks` endpoint
4. Implement `PATCH /api/chatbot/tasks/:id` endpoint
5. Implement `DELETE /api/chatbot/tasks/:id` endpoint
6. Add input validation with Zod schemas
7. Implement error response formatting
8. Write integration tests for all endpoints

### 8.3. Phase 3: Security & Rate Limiting (Week 3)

**Tasks:**
1. Implement rate limiting middleware
2. Add request logging
3. Add security headers (HSTS)
4. Implement authorization checks
5. Security audit and penetration testing
6. Performance testing and optimization

### 8.4. Phase 4: Telegram Bot Development (Week 4)

**Tasks:**
1. Set up Telegram Bot API integration
2. Implement `/login` command with web link
3. Implement `/authorize <code>` command
4. Implement task creation via natural language
5. Implement task listing with formatting
6. Implement task update and delete commands
7. End-to-end testing with real Telegram bot
8. Deploy to production

## 9. Testing Strategy

### 9.1. Unit Tests

- Auth service: code generation, hashing, token generation
- JWT service: signing, verification, expiration
- Task DTOs: validation logic
- Repositories: CRUD operations (with mocked Firestore)

### 9.2. Integration Tests

- Auth flow: full verification code → session token flow
- Task API: all CRUD operations with real Firestore emulator
- Rate limiting: verify limits are enforced
- Authorization: verify ownership checks work

### 9.3. End-to-End Tests

- Complete user journey: web login → Telegram auth → create task → view task → update task → delete task
- Token expiration handling
- Token revocation

### 9.4. Security Tests

- JWT tampering attempts
- Expired token rejection
- Invalid verification code attempts
- Rate limit bypass attempts
- SQL injection attempts (via malicious task titles)
- Authorization bypass attempts

## 10. Monitoring & Observability

### 10.1. Metrics to Track

- Authentication success/failure rate
- API request latency (p50, p95, p99)
- Error rate per endpoint
- Rate limit hit rate
- Active session count
- Token generation rate

### 10.2. Alerts

- Error rate > 5% for any endpoint
- Authentication failure rate > 10%
- API latency p95 > 1000ms
- Rate limit violations spike

### 10.3. Logs

- All authentication events
- All API requests (endpoint, status code, latency, user ID)
- All errors with stack traces
- Rate limit violations
